<%#
	Material is a clean HTML5 theme for LuCI. It is based on luci-theme-bootstrap and MUI

	luci-theme-material
	Copyright 2015-2017 Lutty Yang <lutty@wcan.in>

	Have a bug? Please create an issue here on GitHub!
	https://github.com/LuttyYang/luci-theme-material/issues

	luci-theme-bootstrap:
	Copyright 2008 Steven Barth <steven@midlink.org>
	Copyright 2008-2016 Jo-Philipp Wich <jow@openwrt.org>
	Copyright 2012 David Menting <david@nut-bolt.nl>

	MUI:
	https://github.com/muicss/mui

	Licensed to the public under the Apache License 2.0
-%>

<%
	local sys  = require "luci.sys"
	local util = require "luci.util"
	local http = require "luci.http"
	local disp = require "luci.dispatcher"

	local boardinfo = util.ubus("system", "board")

	local request  = disp.context.path
	local request2 = disp.context.request

	local category = request[1]
	local cattree  = category and disp.node(category)

	local leaf = request2[#request2]

	local tree = disp.node()
	local node = disp.context.dispatched

	local categories = disp.node_childs(tree)

	local c = tree
	local i, r

	-- tag all nodes leading to this page
	for i, r in ipairs(request) do
		if c.nodes and c.nodes[r] then
			c = c.nodes[r]
			c._menu_selected = true
		end
	end

	-- send as HTML5
	http.prepare_content("text/html")

	local function nodeurl(prefix, name, query)
		local u = url(prefix, name)
		if query then
			u = u .. http.build_querystring(query)
		end
		return pcdata(u)
	end

	local function render_tabmenu(prefix, node, level)
		if not level then
			level = 1
		end

		local childs = disp.node_childs(node)
		if #childs > 0 then
			if level > 2 then
				write('<ul class="tabs">')
			end

			local selected_node
			local selected_name
			local i, v

			for i, v in ipairs(childs) do
				local nnode = node.nodes[v]
				if nnode._menu_selected then
					selected_node = nnode
					selected_name = v
				end

				if level > 2 then
					write('<li class="tabmenu-item-%s %s"><a href="%s">%s</a></li>' %{
						v, (nnode._menu_selected or (node.leaf and v == leaf)) and 'active' or '',
						nodeurl(prefix, v, nnode.query),
						striptags(translate(nnode.title))
					})
				end
			end

			if level > 2 then
				write('</ul>')
			end

			if selected_node then
				render_tabmenu(prefix .. "/" .. selected_name, selected_node, level + 1)
			end
		end
	end

	local function render_submenu(prefix, node)
		local childs = disp.node_childs(node)
		if #childs > 0 then
			write('<ul class="slide-menu %s ">' %{node._menu_selected and 'active' or ''})

			for i, r in ipairs(childs) do
				local nnode = node.nodes[r]
				local title = striptags(translate(nnode.title))

				if nnode._menu_selected then
					write('<li class="active"><a data-title="%s" href="%s">%s</a></li>' %{
						title,
						nodeurl(prefix, r, nnode.query),
						title
					})
				else
					write('<li><a data-title="%s" href="%s">%s</a></li>' %{
						title,
						nodeurl(prefix, r, nnode.query),
						title
					})
				end

			end

			write('</ul>')
		end
	end

	local function render_topmenu()
		local childs = disp.node_childs(cattree)
		if #childs > 0 then
			write('<ul class="nav">')

			for i, r in ipairs(childs) do
				local nnode = cattree.nodes[r]
				local grandchildren = disp.node_childs(nnode)

				if #grandchildren > 0 then
					local title = striptags(translate(nnode.title))

					write('<li class="slide"><a class="menu %s" data-title="%s" href="#">%s</a>' %{
						nnode._menu_selected and 'active' or '',
						title,
						title
					})

					render_submenu(category .. "/" .. r, nnode)
					write('</li>')
				else
					local title = striptags(translate(nnode.title))

					write('<li><a data-title="%s" href="%s">%s</a></li>' %{
						title,
						nodeurl(category, r, nnode.query),
						title
					})
				end
			end

			write('</ul>')
		end
	end

	local function render_changes()
		-- calculate the number of unsaved changes
		if tree.nodes[category] and tree.nodes[category].ucidata then
			local ucichanges = 0
			local i, j
			for i, j in pairs(require("luci.model.uci").cursor():changes()) do
				ucichanges = ucichanges + #j
			end

			if ucichanges > 0 then
				write('<a class="uci_change_indicator label notice" href="%s?redir=%s">%s: %d</a>' %{
					url(category, 'uci/changes'),
					http.urlencode(http.formvalue('redir') or table.concat(disp.context.request, "/")),
					translate('Unsaved Changes'),
					ucichanges
				})
			end
		end
	end
-%>
<!DOCTYPE html>
<html lang="<%=luci.i18n.context.lang%>">
<head>
	<meta charset="utf-8">
	<title><%=striptags( (boardinfo.hostname or "?") .. ( (node and node.title) and ' - ' .. translate(node.title) or '')) %> - LuCI</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="theme-color" content="#09c">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="msapplication-TileColor" content="#09c">
	<meta name="application-name" content="<%=striptags( (boardinfo.hostname or "?") ) %> - LuCI">
	<meta name="apple-mobile-web-app-title" content="<%=striptags( (boardinfo.hostname or "?") ) %> - LuCI">
	<link rel="stylesheet" href="<%=media%>/cascade.css">
	<link rel="shortcut icon" href="<%=media%>/favicon.ico">
	<% if node and node.css then %>
		<link rel="stylesheet" href="<%=resource%>/<%=node.css%>">
	<% end -%>
	<% if css then %>
		<style title="text/css"><%= css %></style>
	<% end -%>
	<script src="<%=url('admin/translations', luci.i18n.context.lang)%><%# ?v=PKG_VERSION %>"></script>
	<script src="<%=resource%>/cbi.js"></script>
	<script src="<%=resource%>/xhr.js"></script>
	<script type="text/javascript">//<![CDATA[
		document.addEventListener('DOMContentLoaded', function() {
			var $ = function(e){
				return document.querySelectorAll(e);
			}

			$(".main > .loading").forEach(function (e) {
				if (e) {
					e.style.display = "none";
				}
			});

			$(".main > .main-left > .nav > .slide > .menu").forEach(
			function (e){
				if(e){
					e.addEventListener('click', function(){
						var ul2 = this.nextElementSibling;
						var tag = this;
						if (!ul2.classList.contains("active")) {
							ul2.classList.add("active");
							tag.classList.add("active");
							stop(ul2)
							slideDown(ul2, 16);
						}else{
							ul2.classList.remove("active");
							tag.classList.remove("active");
							stop(ul2)
							slideUp(ul2, 16);
						}
					});

					e.nextElementSibling.querySelectorAll("a").forEach(
					function (a){
						if(a)
						{
							a.parentElement.addEventListener('click', function(ev){
								ev.stopPropagation();
								a.click();
							});

							a.addEventListener('click', function(ev){
								ev.stopPropagation();
							});
						}
					});

					if (e.classList.contains("active")) {
						slideDown(e.nextElementSibling, -1);
					}
				}
			});

			if (!document.querySelector('body').classList.contains('logged-in')) {
				document.querySelector("body").classList.add("node-main-login");
			};

			var showSide = false;
			document.querySelector(".showSide").addEventListener('click', function () {
				if (showSide){
					document.querySelector(".darkMask").setAttribute("style", "display: none");
					widthExpand(stop(document.querySelector(".main-left")), 0, 16);
					document.querySelector(".main-right").setAttribute("style", "overflow-y: visible");
					showSide = false;
				}else{
					document.querySelector(".darkMask").setAttribute("style", "display: block");
					widthExpand(stop(document.querySelector(".main-left")), 15, 16);
					document.querySelector(".main-right").setAttribute("style", "overflow-y: scroll");
					showSide = true;
				}
			});

			window.onresize = function () {
				if (window.innerWidth > 921) {
					document.querySelector(".main-left").removeAttribute("style");
					document.querySelector(".darkMask").removeAttribute("style");
					showSide = false;
				}
			};

			document.querySelector(".darkMask").addEventListener('click', function () {
				if (showSide) {
					showSide = false;
					this.style.display = "none";
					widthExpand(stop(document.querySelector(".main-left")), 0, 16);
					document.querySelector(".main-right").setAttribute("overflow-y", "visible");
				}
			});

			$(".cbi-section >legend").forEach(function(e) {
				if(e){
					e.insertAdjacentHTML("afterend", "<span class='panel-title'>" + e.textContent + "</p>");
				}
			});

			$(".cbi-button-up").forEach(function(e){
				if(e){
					e.value = "";
				}
			});

			$(".cbi-button-down").forEach(function(e){
				if(e){
					e.value = "";
				}
			});


			if (!window.requestAnimationFrame) {
				requestAnimationFrame = function (fn) {
					return setTimeout(fn, 17);
				};
			}

			if (!window.cancelAnimationFrame) {
				cancelAnimationFrame = function (id) {
					clearTimeout(id);
				};
			}

			function stop(ele) {
				if (ele.timmer) {
					cancelAnimationFrame(ele.timmer);
					delete ele.timmer;
				}
				return ele;
			}

			function easeOutExpo(t, c) {
				return c * (- Math.pow(2, - 20 * t) + 1);
			}

			function genAnimation(ele, attr, fromValue, toValue, delta, callback) {
				var start = 1;
				var flag = toValue - fromValue > 0 ? 1 : -1;
				var duration = delta < 0 ? 1 : Math.abs(toValue - fromValue) / delta;
				var ampl = delta < 0 ? (toValue - fromValue) * 2 : flag * duration / (duration - 1) * delta;
				ele.timmer = requestAnimationFrame(function udf() {
					fromValue += easeOutExpo(start / duration, ampl);
					start++;
					if (flag * fromValue < flag * toValue){
						stop(ele);
						ele.setAttribute("style", "display: block;overflow: hidden;" + attr + ": " + fromValue + "px");
						ele.timmer = requestAnimationFrame(udf);
					}else{
						if (callback) callback(ele);
						stop(ele);
					}
				});
			}

			function slideUp(ele, delta) {
				var fromHeight = ele.offsetHeight;
				var toHeight = 0;

				genAnimation(ele, 'height', fromHeight, toHeight, delta, function (ele) {
					ele.removeAttribute("style");
				});
			}

			function slideDown(ele, delta) {
				ele.setAttribute("style", "display: block; position: absolute; visibility: hidden");
				var toHeight = ele.offsetHeight;
				ele.removeAttribute("style");
				var fromHeight = ele.offsetHeight;

				genAnimation(ele, 'height', fromHeight, toHeight, delta, function (ele) {
					ele.removeAttribute("style");
					ele.setAttribute("style", "display: block;");
				});
			}

			function widthExpand(ele, toWidth, delta){
				var fromWidth = ele.offsetWidth;
				toWidth = toWidth * 16;

				genAnimation(ele, 'width', fromWidth, toWidth, delta, function (ele) {
					ele.setAttribute("style", "width: " + toWidth + "px");
				});
			}
		});
	//]]></script>
</head>
<body class="lang_<%=luci.i18n.context.lang%> <% if node then %><%= striptags( node.title ) %><% end %> <% if disp.context.authsession then %>logged-in<% end %>" <% if next(request) then %>data-page="<%= table.concat(request, '-') %>"<% end %>>
<header>
	<div class="fill">
		<div class="container">
			<span class="showSide"></span>
			<img src="<%=media%>/brand.png"/>
			<a class="brand" href="#"><%=boardinfo.hostname or "?"%></a>
			<div class="status">
				<% render_changes() %>
				<span id="xhr_poll_status" style="display:none" onclick="XHR.running() ? XHR.halt() : XHR.run()">
					<span class="label success" id="xhr_poll_status_on"><span class="mobile-hide"><%:Auto Refresh%></span> <%:on%></span>
					<span class="label" id="xhr_poll_status_off" style="display:none"><span class="mobile-hide"><%:Auto Refresh%></span> <%:off%></span>
				</span>
			</div>
		</div>
	</div>
</header>
<div class="main">
	<div style="" class="loading"><span><div class="loading-img"></div>Loading...</span></div>
	<div class="main-left">
		<% render_topmenu() %>
	</div>
	<div class="main-right">
		<div class="darkMask"></div>
		<div id="maincontent">
			<div class="container">
				<%- if luci.sys.process.info("uid") == 0 and luci.sys.user.getuser("root") and not luci.sys.user.getpasswd("root") then -%>
					<div class="alert-message warning">
						<h4><%:No password set!%></h4>
						<p><%:There is no password set on this router. Please configure a root password to protect the web interface and enable SSH.%></p>
						<% if disp.lookup("admin/system/admin") then %>
							<div class="right"><a class="btn" href="<%=url("admin/system/admin")%>"><%:Go to password configuration...%></a></div>
						<% end %>
					</div>
				<%- end -%>

				<noscript>
					<div class="alert-message warning">
						<h4><%:JavaScript required!%></h4>
						<p><%:You must enable JavaScript in your browser or LuCI will not work properly.%></p>
					</div>
				</noscript>

				<% if category then render_tabmenu(category, cattree) end %>
